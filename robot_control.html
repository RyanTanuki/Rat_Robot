<!DOCTYPE html>
<html>
<head>
    <title>Robot Control Panel</title>
    <style>
        /* Base styling for body */
        body {
            background-color: #f0f8ff;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
        }
        
        /* Container for servo control sliders */
        .servo-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 800px;
        }
        
        /* Individual servo slider styling */
        .servo-slider {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .slider {
            width: 300px;
        }
        
        /* Video feed container styling */
        .camera-feed {
            width: 640px;
            height: 480px;
            background-color: #ddd;
            margin: 20px;
            border: 2px solid #999;
            border-radius: 5px;
        }
        
        /* Joystick container layout */
        .joystick-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 800px;
            margin-top: 20px;
        }
        
        /* Base joystick styling */
        .joystick {
            width: 150px;
            height: 150px;
            border: 2px solid #000;
            border-radius: 50%;
            position: relative;
            touch-action: none; /* Prevents touch scrolling */
        }
        
        /* Joystick handle styling */
        .stick {
            width: 50px;
            height: 50px;
            background-color: #666;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: move;
        }
    </style>
</head>
<body>
    <!-- Servo Control Section -->
    <div class="servo-controls">
        <!-- Individual servo sliders with value display -->
        <div class="servo-slider">
            <span>Servo 1:</span>
            <input type="range" class="slider" id="servo1" min="0" max="180" value="90">
            <span id="servo1Value">90°</span>
        </div>
        <!-- Repeat for servos 2-4 -->
        <!-- ... -->
    </div>

    <!-- Live Camera Feed -->
    <div class="camera-feed">
        <img src="http://192.168.68.80:8080/?action=stream" style="width:100%;height:100%;object-fit:contain;">
    </div>

    <!-- Dual Joystick Controls -->
    <div class="joystick-container">
        <!-- Movement joystick (left) -->
        <div class="joystick" id="moveJoystick">
            <div class="stick"></div>
        </div>
        <!-- Camera control joystick (right) -->
        <div class="joystick" id="cameraJoystick">
            <div class="stick"></div>
        </div>
    </div>

    <script>
        /**
         * Joystick Class
         * Handles touch and mouse input for virtual joystick controls
         */
        class Joystick {
            /**
             * @param {HTMLElement} element - The joystick container element
             * @param {Function} onMove - Callback for joystick movement
             * @param {Function} onEnd - Callback for joystick release
             */
            constructor(element, onMove, onEnd) {
                this.element = element;
                this.stick = element.querySelector('.stick');
                this.maxDistance = 50;  // Maximum stick travel distance
                this.active = false;
                this.onMove = onMove;
                this.onEnd = onEnd;
                
                this.initEvents();
            }

            /**
             * Initialize mouse and touch event listeners
             */
            initEvents() {
                // Mouse events
                this.element.addEventListener('mousedown', this.start.bind(this));
                document.addEventListener('mousemove', this.move.bind(this));
                document.addEventListener('mouseup', this.end.bind(this));
                
                // Touch events
                this.element.addEventListener('touchstart', this.start.bind(this));
                document.addEventListener('touchmove', this.move.bind(this));
                document.addEventListener('touchend', this.end.bind(this));
            }

            /**
             * Handle joystick activation
             */
            start(e) {
                this.active = true;
                e.preventDefault();
            }

            /**
             * Handle joystick movement
             * Calculates position and triggers movement callback
             */
            move(e) {
                if (!this.active) return;
                
                const rect = this.element.getBoundingClientRect();
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                
                // Get position based on input type
                let x, y;
                if (e.type.startsWith('mouse')) {
                    x = e.clientX - rect.left - centerX;
                    y = e.clientY - rect.top - centerY;
                } else {
                    x = e.touches[0].clientX - rect.left - centerX;
                    y = e.touches[0].clientY - rect.top - centerY;
                }

                // Calculate movement vector
                const distance = Math.min(Math.sqrt(x*x + y*y), this.maxDistance);
                const angle = Math.atan2(y, x);
                
                const moveX = distance * Math.cos(angle);
                const moveY = distance * Math.sin(angle);
                
                // Update stick position
                this.stick.style.transform = `translate(${moveX}px, ${moveY}px)`;
                
                // Trigger movement callback
                if (this.onMove) {
                    this.onMove(moveX / this.maxDistance, moveY / this.maxDistance);
                }
                
                e.preventDefault();
            }

            /**
             * Handle joystick release
             * Resets position and triggers end callback
             */
            end() {
                if (!this.active) return;
                this.active = false;
                this.stick.style.transform = 'translate(0px, 0px)';
                if (this.onEnd) this.onEnd();
            }
        }

        // Initialize movement joystick with tank drive controls
        new Joystick(document.getElementById('moveJoystick'), 
            (x, y) => {
                // Convert joystick position to motor speeds
                const maxSpeed = 100;
                let left = -y * maxSpeed;  // Invert Y axis for intuitive control
                let right = -y * maxSpeed;
                
                // Apply turning adjustment
                if (x !== 0) {
                    if (x > 0) {
                        left *= (1 - Math.abs(x));  // Reduce left motor for right turn
                    } else {
                        right *= (1 - Math.abs(x)); // Reduce right motor for left turn
                    }
                }
                
                // Clamp values to valid range
                left = Math.max(Math.min(left, 100), -100);
                right = Math.max(Math.min(right, 100), -100);
                
                // Send motor command
                sendCommand({
                    type: 'motor',
                    left: left,
                    right: right
                });
            },
            // Stop motors on joystick release
            () => sendCommand({type: 'motor', left: 0, right: 0})
        );

        // Initialize camera control joystick
        let panAngle = 90;
        let tiltAngle = 90;
        
        new Joystick(document.getElementById('cameraJoystick'),
            (x, y) => {
                // Update camera angles based on joystick position
                panAngle = Math.max(0, Math.min(180, panAngle + x * 5));
                tiltAngle = Math.max(0, Math.min(180, tiltAngle - y * 5));
                
                // Send servo commands for pan/tilt
                sendCommand({type: 'servo', id: 8, angle: Math.round(panAngle)});
                sendCommand({type: 'servo', id: 7, angle: Math.round(tiltAngle)});
            }
        );

        // Initialize servo control sliders
        for (let i = 1; i <= 4; i++) {
            const slider = document.getElementById(`servo${i}`);
            const value = document.getElementById(`servo${i}Value`);
            
            slider.addEventListener('input', () => {
                const angle = parseInt(slider.value);
                value.textContent = `${angle}°`;
                sendCommand({type: 'servo', id: i, angle: angle});
            });
        }

        /**
         * Send control command to backend
         * @param {Object} command - Command object to send
         */
        async function sendCommand(command) {
            try {
                console.log('Sending command:', command);
                let endpoint = '/motor';
                if (command.type === 'servo') {
                    endpoint = '/servo';
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(command)
                });
                const data = await response.json();
                console.log('Response:', data);
            } catch (error) {
                console.error('Error sending command:', error);
            }
        }

        // Keyboard control implementation
        document.addEventListener('keydown', (event) => {
            if (event.repeat) return; // Ignore key repeat events
            
            event.preventDefault();
            let left = 0, right = 0;
            const speed = 50; // Reduced speed for keyboard control
            
            // Handle different key inputs
            switch(event.key.toLowerCase()) {
                case 'w': left = speed; right = speed; break;      // Forward
                case 's': left = -speed; right = -speed; break;    // Backward
                case 'a': left = -speed; right = speed; break;     // Turn left
                case 'd': left = speed; right = -speed; break;     // Turn right
                // Camera controls
                case 'arrowleft': 
                    sendCommand({type: 'servo', servo: 8, angle: Math.max(0, panAngle - 5)}); 
                    panAngle = Math.max(0, panAngle - 5);
                    return;
                case 'arrowright': 
                    sendCommand({type: 'servo', servo: 8, angle: Math.min(180, panAngle + 5)}); 
                    panAngle = Math.min(180, panAngle + 5);
                    return;
                case 'arrowup': 
                    sendCommand({type: 'servo', servo: 7, angle: Math.max(0, tiltAngle - 5)}); 
                    tiltAngle = Math.max(0, tiltAngle - 5);
                    return;
                case 'arrowdown': 
                    sendCommand({type: 'servo', servo: 7, angle: Math.min(180, tiltAngle + 5)}); 
                    tiltAngle = Math.min(180, tiltAngle + 5);
                    return;
            }
            
            // Send motor command if movement keys pressed
            if (left !== 0 || right !== 0) {
                sendCommand({type: 'motor', left: left, right: right});
            }
        });

        // Stop motors when movement keys are released
        document.addEventListener('keyup', (event) => {
            if (['w', 's', 'a', 'd'].includes(event.key.toLowerCase())) {
                sendCommand({type: 'motor', direction: 'stop', left: 0, right: 0});
            }
        });
    </script>
</body>
</html> 
<!DOCTYPE html>
<html>
<head>
    <title>Robot Control Panel</title>
    <style>
        body {
            background-color: #f0f8ff;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
        }
        
        .servo-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 800px;
        }
        
        .servo-slider {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .slider {
            width: 300px;
        }
        
        .camera-feed {
            width: 640px;
            height: 480px;
            background-color: #ddd;
            margin: 20px;
            border: 2px solid #999;
            border-radius: 5px;
        }
        
        .joystick-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 800px;
            margin-top: 20px;
        }
        
        .joystick {
            width: 150px;
            height: 150px;
            border: 2px solid #000;
            border-radius: 50%;
            position: relative;
            touch-action: none;
        }
        
        .stick {
            width: 50px;
            height: 50px;
            background-color: #666;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: move;
        }
    </style>
</head>
<body>
    <!-- Servo Controls -->
    <div class="servo-controls">
        <div class="servo-slider">
            <span>Servo 1:</span>
            <input type="range" class="slider" id="servo1" min="0" max="180" value="90">
            <span id="servo1Value">90°</span>
        </div>
        <div class="servo-slider">
            <span>Servo 2:</span>
            <input type="range" class="slider" id="servo2" min="0" max="180" value="90">
            <span id="servo2Value">90°</span>
        </div>
        <div class="servo-slider">
            <span>Servo 3:</span>
            <input type="range" class="slider" id="servo3" min="0" max="180" value="90">
            <span id="servo3Value">90°</span>
        </div>
        <div class="servo-slider">
            <span>Servo 4:</span>
            <input type="range" class="slider" id="servo4" min="0" max="180" value="90">
            <span id="servo4Value">90°</span>
        </div>
    </div>

    <!-- Camera Feed -->
    <div class="camera-feed">
        <img src="http://192.168.68.80:8080/?action=stream" style="width:100%;height:100%;object-fit:contain;">
    </div>

    <!-- Joysticks -->
    <div class="joystick-container">
        <div class="joystick" id="moveJoystick">
            <div class="stick"></div>
        </div>
        <div class="joystick" id="cameraJoystick">
            <div class="stick"></div>
        </div>
    </div>

    <script>
        // Joystick class implementation
        class Joystick {
            constructor(element, onMove, onEnd) {
                this.element = element;
                this.stick = element.querySelector('.stick');
                this.maxDistance = 50;
                this.active = false;
                this.onMove = onMove;
                this.onEnd = onEnd;
                
                this.initEvents();
            }

            initEvents() {
                this.element.addEventListener('mousedown', this.start.bind(this));
                document.addEventListener('mousemove', this.move.bind(this));
                document.addEventListener('mouseup', this.end.bind(this));
                
                this.element.addEventListener('touchstart', this.start.bind(this));
                document.addEventListener('touchmove', this.move.bind(this));
                document.addEventListener('touchend', this.end.bind(this));
            }

            start(e) {
                this.active = true;
                e.preventDefault();
            }

            move(e) {
                if (!this.active) return;
                
                const rect = this.element.getBoundingClientRect();
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                
                let x, y;
                if (e.type.startsWith('mouse')) {
                    x = e.clientX - rect.left - centerX;
                    y = e.clientY - rect.top - centerY;
                } else {
                    x = e.touches[0].clientX - rect.left - centerX;
                    y = e.touches[0].clientY - rect.top - centerY;
                }

                const distance = Math.min(Math.sqrt(x*x + y*y), this.maxDistance);
                const angle = Math.atan2(y, x);
                
                const moveX = distance * Math.cos(angle);
                const moveY = distance * Math.sin(angle);
                
                this.stick.style.transform = `translate(${moveX}px, ${moveY}px)`;
                
                if (this.onMove) {
                    this.onMove(moveX / this.maxDistance, moveY / this.maxDistance);
                }
                
                e.preventDefault();
            }

            end() {
                if (!this.active) return;
                this.active = false;
                this.stick.style.transform = 'translate(0px, 0px)';
                if (this.onEnd) this.onEnd();
            }
        }

        // Initialize movement joystick
        new Joystick(document.getElementById('moveJoystick'), 
            (x, y) => {
                // Normalize x and y to -1 to 1
                const maxSpeed = 100;
                let left = -y * maxSpeed;  // Invert Y axis
                let right = -y * maxSpeed; // Invert Y axis
                
                // Apply turning
                if (x !== 0) {
                    if (x > 0) {
                        left *= (1 - Math.abs(x));  // Reduce left motor for right turn
                    } else {
                        right *= (1 - Math.abs(x)); // Reduce right motor for left turn
                    }
                }
                
                // Ensure values are between -100 and 100
                left = Math.max(Math.min(left, 100), -100);
                right = Math.max(Math.min(right, 100), -100);
                
                console.log(`Sending motor command: left=${left}, right=${right}`);
                sendCommand({
                    type: 'motor',
                    left: left,
                    right: right
                });
            },
            () => {
                console.log('Stopping motors');
                sendCommand({type: 'motor', left: 0, right: 0});
            }
        );

        // Initialize camera joystick
        let panAngle = 90;
        let tiltAngle = 90;
        
        new Joystick(document.getElementById('cameraJoystick'),
            (x, y) => {
                panAngle = Math.max(0, Math.min(180, panAngle + x * 5));
                tiltAngle = Math.max(0, Math.min(180, tiltAngle - y * 5));
                sendCommand({type: 'servo', id: 8, angle: Math.round(panAngle)});
                sendCommand({type: 'servo', id: 7, angle: Math.round(tiltAngle)});
            }
        );

        // Initialize servo controls
        for (let i = 1; i <= 4; i++) {
            const slider = document.getElementById(`servo${i}`);
            const value = document.getElementById(`servo${i}Value`);
            
            slider.addEventListener('input', () => {
                const angle = parseInt(slider.value);
                value.textContent = `${angle}°`;
                sendCommand({type: 'servo', id: i, angle: angle});
            });
        }

        // Command sending function
        async function sendCommand(command) {
            try {
                console.log('Sending command:', command);
                let endpoint = '/motor';
                if (command.type === 'servo') {
                    endpoint = '/servo';
                }
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(command)
                });
                const data = await response.json();
                console.log('Response:', data);
            } catch (error) {
                console.error('Error sending command:', error);
            }
        }

        // Keyboard controls
        document.addEventListener('keydown', (event) => {
            if (event.repeat) return; // Ignore key repeat events
            
            event.preventDefault();
            let left = 0, right = 0;
            const speed = 50; // Reduced from 100 for better control
            
            switch(event.key.toLowerCase()) {
                case 'w': left = speed; right = speed; break;
                case 's': left = -speed; right = -speed; break;
                case 'a': left = -speed; right = speed; break;
                case 'd': left = speed; right = -speed; break;
                case 'arrowleft': 
                    sendCommand({type: 'servo', servo: 8, angle: Math.max(0, panAngle - 5)}); 
                    panAngle = Math.max(0, panAngle - 5);
                    return;
                case 'arrowright': 
                    sendCommand({type: 'servo', servo: 8, angle: Math.min(180, panAngle + 5)}); 
                    panAngle = Math.min(180, panAngle + 5);
                    return;
                case 'arrowup': 
                    sendCommand({type: 'servo', servo: 7, angle: Math.max(0, tiltAngle - 5)}); 
                    tiltAngle = Math.max(0, tiltAngle - 5);
                    return;
                case 'arrowdown': 
                    sendCommand({type: 'servo', servo: 7, angle: Math.min(180, tiltAngle + 5)}); 
                    tiltAngle = Math.min(180, tiltAngle + 5);
                    return;
            }
            
            if (left !== 0 || right !== 0) {
                console.log(`Sending keyboard command: left=${left}, right=${right}`);
                sendCommand({type: 'motor', left: left, right: right});
            }
        });

        document.addEventListener('keyup', (event) => {
            if (['w', 's', 'a', 'd'].includes(event.key.toLowerCase())) {
                sendCommand({type: 'motor', direction: 'stop', left: 0, right: 0});
            }
        });
    </script>
</body>
</html> 